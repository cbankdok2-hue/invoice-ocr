<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Invoice OCR â€“ Auto + Manual (Professional)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin: 10px; }
.top { margin-bottom: 10px; }
.container { display: flex; gap: 10px; }

#pdfWrap { position: relative; border: 1px solid #aaa; }
canvas { display: block; }

#box {
  position: absolute;
  border: 2px dashed red;
  pointer-events: none;
}

.right { width: 320px; }
input, button { width: 100%; margin-bottom: 6px; padding: 6px; }

#progress { font-size: 13px; margin: 6px 0; }
#log {
  background: #f4f4f4;
  height: 150px;
  overflow: auto;
  font-size: 12px;
  padding: 6px;
}
</style>
</head>

<body>

<h3>Invoice OCR â€“ Auto + Manual (Accurate)</h3>

<div class="top">
  <input type="file" id="files" multiple accept="application/pdf">
</div>

<div class="container">
  <div id="pdfWrap">
    <canvas id="canvas"></canvas>
    <div id="box"></div>
  </div>

  <div class="right">
    <div id="progress"></div>

    <label>Internal Ref No</label>
    <input id="ref" readonly>

    <label>Invoice Date</label>
    <input id="date">

    <button onclick="manualOCR()">Manual OCR (Drag)</button>
    <button onclick="next()">Next PDF</button>
    <button onclick="download()">Download Excel</button>

    <button onclick="zoomIn()">Zoom +</button>
    <button onclick="zoomOut()">Zoom -</button>

    <div id="log"></div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
 "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const c = document.getElementById("canvas");
const ctx = c.getContext("2d");
const box = document.getElementById("box");
const log = t => document.getElementById("log").textContent += t + "\n";

let files=[], i=0, pdf, page, scale=2;
let sx,sy,ex,ey,drag=false;
let excel=[["Internal Ref No","Invoice Date"]];

document.getElementById("files").onchange=e=>{
 files=[...e.target.files];
 i=0; load();
};

async function load(){
 if(!files[i]) return;
 document.getElementById("ref").value=files[i].name.replace(/\.pdf$/i,"");
 document.getElementById("date").value="";
 updateProgress();

 pdf=await pdfjsLib.getDocument({data:await files[i].arrayBuffer()}).promise;
 page=await pdf.getPage(1);

 const vp=page.getViewport({scale});
 c.width=vp.width; c.height=vp.height;
 await page.render({canvasContext:ctx,viewport:vp}).promise;

 autoOCR(); // ðŸ”¥ AUTO OCR FIRST
}

async function autoOCR(){
 log("Auto OCR...");
 const crop=document.createElement("canvas");
 crop.width=c.width; crop.height=c.height;
 crop.getContext("2d").drawImage(c,0,0);

 const r=await Tesseract.recognize(crop,"eng");
 const m=r.data.text.match(/Invoice\s*Date[^0-9]*(\d{1,4}[\/.\-]\d{1,2}[\/.\-]\d{1,4})/i);

 if(m){
   document.getElementById("date").value=normalize(m[1]);
   log("Auto OCR success");
   setTimeout(next,600); // auto move
 }else{
   log("Auto OCR failed â†’ use manual drag");
 }
}

c.onmousedown=e=>{
 const r=c.getBoundingClientRect();
 sx=e.clientX-r.left; sy=e.clientY-r.top; drag=true;
};
c.onmousemove=e=>{
 if(!drag) return;
 const r=c.getBoundingClientRect();
 ex=e.clientX-r.left; ey=e.clientY-r.top;
 box.style.left=Math.min(sx,ex)+"px";
 box.style.top=Math.min(sy,ey)+"px";
 box.style.width=Math.abs(ex-sx)+"px";
 box.style.height=Math.abs(ey-sy)+"px";
};
c.onmouseup=()=>drag=false;

async function manualOCR(){
 if(!sx||!ex) return alert("Drag area first");
 const w=Math.abs(ex-sx), h=Math.abs(ey-sy);
 const crop=document.createElement("canvas");
 crop.width=w; crop.height=h;
 crop.getContext("2d").drawImage(
   c,Math.min(sx,ex),Math.min(sy,ey),w,h,0,0,w,h
 );
 const r=await Tesseract.recognize(
  crop,"eng",{tessedit_char_whitelist:"0123456789./-"}
 );
 const m=r.data.text.match(/\d{1,4}[\/.\-]\d{1,2}[\/.\-]\d{1,4}/);
 if(m){
   document.getElementById("date").value=normalize(m[0]);
   log("Manual OCR success");
 }
}

function next(){
 excel.push([ref.value,date.value]);
 i++; load();
}

function normalize(d){
 const p=d.replace(/-/g,"/").split("/");
 if(p[0].length===4) return `${p[0]}-${p[1].padStart(2,"0")}-${p[2].padStart(2,"0")}`;
 return `${p[2]}-${p[1].padStart(2,"0")}-${p[0].padStart(2,"0")}`;
}

function updateProgress(){
 document.getElementById("progress").textContent=
  `PDF ${i+1}/${files.length} (${Math.round(i/files.length*100)}%)`;
}

function zoomIn(){ scale+=0.3; load(); }
function zoomOut(){ scale=Math.max(1,scale-0.3); load(); }

function download(){
 const ws=XLSX.utils.aoa_to_sheet(excel);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Invoices");
 XLSX.writeFile(wb,"Invoice_Data.xlsx");
}
</script>

</body>
</html>
