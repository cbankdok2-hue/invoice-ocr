<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Invoice OCR – Final Professional</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; margin:10px; }
.container { display:flex; gap:10px; }
#pdfWrap { border:1px solid #999; }
canvas { display:block; }
.right { width:340px; }

input, button, select {
  width:100%;
  margin-bottom:6px;
  padding:6px;
}

.invalid { border:2px solid red; }
.valid { border:2px solid green; }

button:disabled { background:#ccc; cursor:not-allowed; }

#processWrap { display:none; }
</style>
</head>

<body>

<h3>Invoice OCR – Auto + Manual + Validation</h3>

<input type="file" id="files" multiple accept="application/pdf">

<div class="container">
  <div id="pdfWrap">
    <canvas id="canvas"></canvas>
  </div>

  <div class="right">
    <div id="progress"></div>

    <button onclick="toggleProcess()">Process ▼</button>
    <div id="processWrap">
      <select id="process" size="8"></select>
    </div>

    <label>Internal Ref No</label>
    <input id="ref" readonly>

    <label>Invoice Date (DD-MM-YYYY)</label>
    <input id="date" placeholder="10-12-2024">

    <button id="nextBtn" onclick="nextPDF()" disabled>Next PDF</button>
    <button onclick="clearCurrent()">Clear</button>
    <button onclick="download()">Download Excel</button>
  </div>
</div>

<script>
// ================= SETUP =================
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const processList = document.getElementById("process");
const processWrap = document.getElementById("processWrap");
const dateInput = document.getElementById("date");
const nextBtn = document.getElementById("nextBtn");
const progress = document.getElementById("progress");
const ref = document.getElementById("ref");

let files=[], index=0;
let excel=[["Internal Ref No","Invoice Date"]];
let loggedSteps = new Set();

// ================= PROCESS =================
function logStep(step){
  if(loggedSteps.has(step)) return;
  loggedSteps.add(step);
  const opt = document.createElement("option");
  opt.textContent = step;
  processList.appendChild(opt);
}

// ================= TOGGLE =================
function toggleProcess(){
  processWrap.style.display =
    processWrap.style.display==="none" ? "block" : "none";
}

// ================= FILE LOAD =================
document.getElementById("files").onchange = ()=>{
  files=[...event.target.files];
  index=0;
  excel=[["Internal Ref No","Invoice Date"]];
  loadPDF();
};

// ================= LOAD PDF =================
async function loadPDF(){
  if(index>=files.length){
    progress.textContent="✅ All PDFs processed";
    return;
  }

  loggedSteps.clear();
  processList.innerHTML="";
  nextBtn.disabled=true;
  dateInput.value="";
  dateInput.className="";

  ref.value = files[index].name.replace(/\.pdf$/i,"");
  progress.textContent = `PDF ${index+1}/${files.length}`;

  logStep("PDF Loaded");

  const data = await files[index].arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data}).promise;
  const page = await pdf.getPage(1);
  const vp = page.getViewport({scale:2});

  canvas.width = vp.width;
  canvas.height = vp.height;
  await page.render({canvasContext:ctx, viewport:vp}).promise;

  autoOCR();
}

// ================= AUTO OCR =================
async function autoOCR(){
  logStep("Auto OCR Started");
  const r = await Tesseract.recognize(canvas,"eng");
  const lines = r.data.text.split("\n");

  for(const l of lines){
    if(/invoice\s*date/i.test(l)){
      const m = l.match(/\d{1,2}[.\-\/]\d{1,2}[.\-\/]\d{4}/);
      if(m && applyDate(m[0],"Auto OCR")){
        logStep("Auto OCR Success");
        setTimeout(nextPDF,500);
        return;
      }
    }
  }
  logStep("Auto OCR Failed – Manual Needed");
}

// ================= DATE VALIDATION =================
dateInput.oninput = ()=>{
  applyDate(dateInput.value,"Manual Typing");
};

// ENTER = NEXT
dateInput.onkeydown = e =>{
  if(e.key==="Enter" && !nextBtn.disabled){
    nextPDF();
  }
};

function applyDate(raw, source){
  logStep(source);
  const d = normalize(raw);
  if(d){
    dateInput.value=d;
    dateInput.className="valid";
    nextBtn.disabled=false;
    logStep("Date Valid");
    return true;
  }else{
    dateInput.className="invalid";
    nextBtn.disabled=true;
    logStep("Date Invalid – Blocked");
    return false;
  }
}

// ================= NEXT =================
function nextPDF(){
  if(nextBtn.disabled) return;
  excel.push([ref.value, dateInput.value]);
  logStep("Saved to Excel");
  index++;
  loadPDF();
}

// ================= CLEAR =================
function clearCurrent(){
  dateInput.value="";
  dateInput.className="";
  nextBtn.disabled=true;
  processList.innerHTML="";
  loggedSteps.clear();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  logStep("Cleared Current PDF");
}

// ================= DATE RULE =================
function normalize(raw){
  const p = raw.replace(/[.\-/]/g,"-").split("-");
  if(p.length!==3) return "";
  const d = `${p[0].padStart(2,"0")}-${p[1].padStart(2,"0")}-${p[2]}`;
  return isValid(d)?d:"";
}

function isValid(d){
  if(!/^\d{2}-\d{2}-\d{4}$/.test(d)) return false;
  const [dd,mm,yy]=d.split("-").map(Number);
  if(mm<1||mm>12||dd<1||dd>31) return false;
  const dim=[31,(yy%4===0&&(yy%100!==0||yy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];
  return dd<=dim[mm-1];
}

// ================= DOWNLOAD =================
function download(){
  const ws=XLSX.utils.aoa_to_sheet(excel);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Invoices");
  XLSX.writeFile(wb,"Invoice_Data.xlsx");
}
</script>

</body>
</html>
